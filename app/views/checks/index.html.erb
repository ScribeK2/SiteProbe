<div>
  <%# Header %>
  <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-10">
    <div>
      <h1 class="text-4xl md:text-5xl font-extrabold tracking-tight mb-2">Check History</h1>
      <p class="text-gray-600">Your past domain health checks</p>
    </div>
    <%= link_to new_check_path, class: "btn-retro inline-flex" do %>
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
      </svg>
      New Check
    <% end %>
  </div>

  <% if @domain_checks.any? %>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
      <% @domain_checks.each_with_index do |check, idx| %>
        <% 
          # Count issues for this check
          issue_count = 0
          critical_count = 0
          warning_count = 0
          
          if check.whois_data.present?
            whois = check.whois_data.with_indifferent_access
            if whois[:issues].present?
              whois[:issues].each do |issue|
                issue_count += 1
                severity = issue[:severity] || issue["severity"]
                critical_count += 1 if severity == "critical"
                warning_count += 1 if severity == "warning"
              end
            end
          end
          
          if check.dns_data.present?
            dns = check.dns_data.with_indifferent_access
            if dns[:issues].present?
              dns[:issues].each do |issue|
                issue_count += 1
                severity = issue[:severity] || issue["severity"]
                critical_count += 1 if severity == "critical"
                warning_count += 1 if severity == "warning"
              end
            end
          end
          
          if check.ssl_data.present?
            ssl = check.ssl_data.with_indifferent_access
            if ssl[:issues].present?
              ssl[:issues].each do |issue|
                issue_count += 1
                severity = issue[:severity] || issue["severity"]
                critical_count += 1 if severity == "critical"
                warning_count += 1 if severity == "warning"
              end
            end
          end
          
          if check.http_data.present?
            http = check.http_data.with_indifferent_access
            if http[:issues].present?
              http[:issues].each do |issue|
                issue_count += 1
                severity = issue[:severity] || issue["severity"]
                critical_count += 1 if severity == "critical"
                warning_count += 1 if severity == "warning"
              end
            end
          end
          
          # Determine status
          if check.completed?
            if critical_count > 0
              stripe_class = "stripes-red"
              status_color = "red"
            elsif warning_count > 0
              stripe_class = "stripes-orange"
              status_color = "orange"
            elsif issue_count == 0
              stripe_class = "stripes-green"
              status_color = "green"
            else
              stripe_class = "stripes-blue"
              status_color = "blue"
            end
          elsif check.processing? || check.pending?
            stripe_class = "stripes-blue"
            status_color = "blue"
          else
            stripe_class = "stripes-red"
            status_color = "red"
          end
          
          rotation_classes = ['rotate-subtle-left', '', 'rotate-subtle-right']
        %>
        
        <%= link_to check_path(check), class: "block sticky-card p-5 card-hover #{rotation_classes[idx % 3]}" do %>
          <div class="absolute bottom-0 left-0 right-0 h-3 <%= stripe_class %> rounded-b-sm"></div>
          
          <%# Pin decoration %>
          <div class="absolute -top-2 left-1/2 -translate-x-1/2 w-4 h-4 rounded-full shadow-md
            <%= case status_color
                when 'green' then 'bg-retro-green'
                when 'orange' then 'bg-retro-orange'
                when 'red' then 'bg-retro-red'
                else 'bg-retro-blue'
                end %>">
          </div>
          
          <div class="pt-3">
            <%# Domain name %>
            <div class="font-mono font-extrabold text-xl truncate mb-2"><%= check.domain %></div>
            
            <%# Timestamp %>
            <div class="text-xs text-gray-500 flex items-center gap-1 mb-4">
              <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
              <%= time_ago_in_words(check.created_at) %> ago
            </div>
            
            <%# Status badge %>
            <div class="flex items-center justify-between">
              <% if check.completed? %>
                <% if critical_count > 0 %>
                  <span class="flex items-center gap-1.5 text-xs font-bold px-3 py-1 bg-retro-red-light text-retro-red rounded-full">
                    <span class="status-dot-critical"></span>
                    <%= critical_count %> critical
                  </span>
                <% elsif warning_count > 0 %>
                  <span class="flex items-center gap-1.5 text-xs font-bold px-3 py-1 bg-retro-orange-light text-retro-orange rounded-full">
                    <span class="status-dot-warning"></span>
                    <%= warning_count %> warning<%= warning_count > 1 ? 's' : '' %>
                  </span>
                <% elsif issue_count == 0 %>
                  <span class="flex items-center gap-1.5 text-xs font-bold px-3 py-1 bg-retro-green-light text-retro-green rounded-full">
                    <span class="status-dot-healthy"></span>
                    All clear
                  </span>
                <% else %>
                  <span class="flex items-center gap-1.5 text-xs font-bold px-3 py-1 bg-retro-blue-light text-retro-blue rounded-full">
                    <span class="status-dot-info"></span>
                    <%= issue_count %> info
                  </span>
                <% end %>
              <% elsif check.processing? || check.pending? %>
                <span class="flex items-center gap-1.5 text-xs font-bold px-3 py-1 bg-retro-blue-light text-retro-blue rounded-full">
                  <span class="w-2 h-2 rounded-full bg-retro-blue animate-pulse-dot"></span>
                  Processing
                </span>
              <% elsif check.failed? %>
                <span class="flex items-center gap-1.5 text-xs font-bold px-3 py-1 bg-retro-red-light text-retro-red rounded-full">
                  <span class="status-dot-critical"></span>
                  Failed
                </span>
              <% end %>
              
              <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
              </svg>
            </div>
            
            <%# Quick info %>
            <% if check.completed? %>
              <div class="mt-4 pt-3 border-t border-gray-100 flex flex-wrap gap-3 text-xs text-gray-500">
                <% if check.whois_data.present? %>
                  <% whois = check.whois_data.with_indifferent_access %>
                  <% if whois[:success] && whois[:expiration_date].present? %>
                    <div class="flex items-center gap-1">
                      <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                      </svg>
                      <% begin %>
                        <% expiry = Date.parse(whois[:expiration_date]) %>
                        <% days_until = (expiry - Date.today).to_i %>
                        <span class="<%= days_until < 30 ? 'text-retro-red font-bold' : (days_until < 90 ? 'text-retro-orange font-bold' : '') %>">
                          <%= expiry.strftime("%b %Y") %>
                        </span>
                      <% rescue %>
                      <% end %>
                    </div>
                  <% end %>
                <% end %>
                
                <% if check.dns_data.present? %>
                  <% dns = check.dns_data.with_indifferent_access %>
                  <% if dns[:success] && dns[:a_records].present? %>
                    <div class="flex items-center gap-1 font-mono">
                      <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"/>
                      </svg>
                      <%= dns[:a_records].first %>
                    </div>
                  <% end %>
                <% end %>
              </div>
            <% end %>
          </div>
        <% end %>
      <% end %>
    </div>
  <% else %>
    <div class="sticky-card tape-corners p-12 pt-14 text-center max-w-lg mx-auto">
      <div class="absolute bottom-0 left-0 right-0 h-3 stripes-purple rounded-b-sm"></div>
      <div class="w-20 h-20 mx-auto mb-6 bg-retro-purple-light rounded-full flex items-center justify-center">
        <svg class="w-10 h-10 text-retro-purple" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
        </svg>
      </div>
      <h3 class="text-2xl font-bold mb-3">No checks yet</h3>
      <p class="text-gray-600 mb-8">Run your first domain health check to see results here.</p>
      <%= link_to new_check_path, class: "btn-retro-yellow inline-flex" do %>
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
        </svg>
        Run your first check
      <% end %>
    </div>
  <% end %>
</div>
